/**
 *  
 *    main.c
 *    
 *    naive k-means
 */



#include "bsg_manycore.h"
#include "bsg_set_tile_x_y.h"
#include <math.h>

#define NPOINT 300
#define NCLUSTER 3
#define NITER 10
#define hex(X) (*(int*)&X)

float data[NPOINT*2] __attribute__ ((section (".dram"))) = {
1.235386,2.327045,1.325127,1.996478,2.356875,0.575495,2.276599,2.111089,
1.838893,2.662918,2.907349,1.836294,2.084801,2.187211,1.797469,2.162829,
2.126507,1.210383,1.302934,1.134439,1.226188,1.389452,1.388741,2.028844,
1.082949,2.602134,0.564855,0.878973,2.505469,0.596477,2.310944,0.712181,
0.660854,2.162605,2.129811,1.806585,2.834149,0.499054,2.577657,0.687934,
1.260860,0.976110,2.005387,2.728407,2.123272,0.833588,3.032635,1.770230,
0.833904,1.115783,2.675925,0.282261,1.717815,1.218420,1.226398,2.093393,
2.838113,1.712723,3.331117,2.651975,1.506162,2.217512,2.215884,0.796369,
2.102921,2.234127,1.917124,1.723147,1.595717,0.867514,2.816939,2.414481,
1.746844,1.906976,1.932698,0.895283,2.554202,2.475758,2.673985,1.497807,
2.329853,2.601419,0.557602,1.909836,1.266367,1.657346,2.220195,2.715838,
2.430746,2.525752,2.023751,2.724756,1.870952,0.633838,2.222656,3.009869,
1.539166,2.247871,3.131262,2.569438,2.216029,2.257651,2.944402,2.401107,
0.542782,1.583845,1.708826,1.298043,3.171044,2.477885,2.901471,2.658240,
2.212992,1.546484,1.473340,0.718999,2.658304,2.464862,0.772026,2.534280,
2.541541,0.773122,3.041198,2.643111,1.109060,1.358724,1.575704,0.724834,
0.823183,1.497086,2.308981,0.775918,1.636994,0.497860,2.700461,0.882193,
2.341105,3.174908,1.695608,1.423954,1.226691,2.002378,2.424575,2.925431,
0.684778,2.408132,1.585131,2.304633,1.751214,0.441912,2.989808,2.458313,
2.005017,0.717877,2.893067,2.006432,1.537034,0.393170,0.785228,1.899343,
2.759111,2.722451,1.494465,0.991148,2.573231,0.840862,0.782208,2.174986,
1.208026,2.073092,0.966026,3.132354,1.812351,2.188321,1.463912,1.812088,
2.286692,1.359429,2.318248,2.589099,2.032497,0.897239,2.419660,3.564871,
2.304790,0.938730,2.426186,0.612045,1.567106,1.002505,0.463809,2.135816,
2.100286,2.845260,2.694214,2.086967,0.872174,1.293851,0.532945,2.873472,
2.818230,2.209686,1.519707,1.734324,1.510555,0.676285,1.681531,1.476692,
2.245985,3.004506,1.401693,2.379155,1.897204,2.180893,0.400183,2.286788,
3.206274,2.688136,2.167826,1.053811,1.448285,0.979643,1.569868,1.056559,
2.696125,2.478902,0.609926,2.415527,2.891911,2.514668,1.033223,1.861913,
2.004472,0.918781,0.608238,1.896112,0.615203,1.957980,2.870065,2.522340,
2.193554,1.063335,2.876199,2.674602,2.789708,2.254596,2.448582,0.942158,
2.189903,2.449598,1.335287,0.691391,2.589629,2.640978,2.570823,2.094730,
2.071460,2.728828,0.729813,1.966216,1.449471,1.155646,0.760646,2.221835,
1.494726,1.871287,2.328397,1.740692,2.093698,1.137683,1.301276,2.309028,
1.090349,1.991177,2.141134,0.799230,1.246226,1.824466,2.193723,2.178497,
0.875530,2.108384,1.819691,0.820677,1.496283,1.472411,1.072552,2.293137,
2.526429,1.388663,2.110804,1.925340,2.411379,1.243863,1.301214,1.347158,
2.911039,2.822847,2.453452,2.350660,1.409555,0.852160,2.460912,0.532279,
3.058575,2.242047,1.672750,0.619870,2.547581,2.823621,1.636994,1.980064,
2.567108,3.187428,0.429062,2.275067,2.079698,2.911363,0.949224,1.441578,
0.565965,2.252448,2.397305,2.585617,0.085143,2.700353,2.183658,1.517053,
1.084029,2.166949,2.029743,1.192237,2.204926,0.117881,1.955141,0.285857,
2.148416,0.631387,3.252707,2.833798,1.832793,1.666543,1.344246,2.246232,
2.016255,1.169869,1.510606,0.918427,2.536998,1.198202,2.985087,2.478939,
0.870711,2.179826,2.907287,1.773664,2.573689,2.549705,2.132476,1.590589,
1.157572,2.437356,2.173580,2.430991,2.578203,1.057535,2.395862,0.117627,
1.207746,2.558130,0.963242,1.496820,2.383006,1.880695,2.329468,0.701746,
1.545752,1.203497,0.697195,2.060888,2.256974,2.067041,1.561115,0.749711,
0.937263,2.385625,1.931196,0.190966,2.170712,0.544466,2.020923,1.236283,
2.301806,1.587045,1.586792,0.866553,2.115595,0.859950,1.735121,1.123392,
0.958527,2.086074,0.936470,1.800376,1.365227,1.300729,1.459813,1.542520,
0.470547,2.196363,2.413418,-0.358164,2.293369,2.555785,1.895262,2.338912,
1.964431,2.594456,2.286457,0.225396,2.171598,3.256004,0.877439,2.490822,
1.397459,1.699961,0.974342,2.293187,2.602370,2.079460,2.172790,0.578944,
2.456541,2.045179,1.329248,0.752339,1.045573,1.783343,1.566446,1.943344,
2.588059,1.877478,0.132994,1.675691,2.162930,1.371614,1.600689,2.177868,
2.322681,2.946183,3.293339,2.704011,2.514672,1.214051,2.625583,1.792516,
1.975280,0.744070,2.253286,1.068333,2.412809,1.013334,2.450106,1.269593,
2.296712,2.244521,2.462406,2.607741,2.441392,2.564670,1.613893,0.657595,
2.043863,3.134451,0.751148,1.577558,1.335816,1.521599,0.356883,2.068379,
3.167628,1.907168,1.915089,1.030785,2.403056,2.711817,1.574155,2.774052,
0.685613,2.011209,2.536101,2.378838,1.869238,0.752296,1.772937,1.789520,
2.350208,1.105710,3.557053,2.710825,1.095006,1.981542,0.573649,1.706613,
1.343074,1.805765,2.056484,2.776718,1.688811,0.833766,2.846678,1.817797,
1.216071,1.756245,1.909989,1.195219,2.465126,1.585635,1.627992,0.931327,
3.102526,1.955830,0.449352,1.349409,2.333468,2.398444,1.092133,2.357302,
1.922757,0.842286,1.688848,1.763536,2.160853,2.757906,2.047162,1.701340,
1.194294,1.790500,1.500458,1.295783,2.066808,1.549264,2.051374,0.475147,
2.357629,2.677213,2.647597,1.770987,2.402154,2.717864,0.905218,2.807260,
1.444165,0.778237,0.246595,2.789594,1.664576,0.884340,1.090126,1.747322,
3.026477,2.138067,2.407147,0.635228,2.109938,2.716515,0.874923,2.352313,
1.472381,1.193168,0.091884,1.922956,0.987817,1.368659,2.220795,2.149578,
0.277847,2.353322,0.910237,1.283205,2.231564,2.956870,1.988108,0.475724,
1.127052,1.655485,3.339942,2.335336,2.155707,1.020388,2.374060,2.370217,
3.330473,2.485783,0.935899,1.583863,2.116574,1.066116,0.988921,1.373489
};

int cluster[NPOINT] __attribute__ ((section (".dram")))  = {0};
float mean_x[NCLUSTER] __attribute__ ((section (".dram")))  = {0};
float mean_y[NCLUSTER] __attribute__ ((section (".dram")))  = {0};


void calculate_mean()
{
  int count[NCLUSTER] = {0};

  for (int i = 0; i < NCLUSTER; i++)
  {
    mean_x[i] = 0.0;
    mean_y[i] = 0.0;
  }

  for (int i = 0; i < NPOINT; i++)
  {
    int nc = cluster[i];
    mean_x[nc] += data[2*i];
    mean_y[nc] += data[(2*i)+1];
    count[nc]++;
  }

  for (int i = 0; i < NCLUSTER; i++)
  {
    mean_x[i] = mean_x[i] / count[i];
    mean_y[i] = mean_y[i] / count[i];
  }
}


void reassign()
{
  int new_cluster;
  float min_dist;

  for (int i = 0; i < NPOINT; i++)
  {
    new_cluster = -1;
    min_dist = INFINITY;

    for (int j = 0; j < NCLUSTER; j++)
    {
      float dx = (mean_x[j] - data[2*i]);
      float dy = (mean_y[j] - data[(2*i)+1]);
      float dist = sqrtf((dx*dx) + (dy*dy));

      if (dist < min_dist)
      {
        min_dist = dist;
        new_cluster = j;
      }
    }

    cluster[i] = new_cluster;
  }
}


int main()
{
  bsg_set_tile_x_y();

  bsg_cuda_print_stat_start(0);
  for (int i = 0; i < NPOINT; i++)
  {
    cluster[i] = i % 3;
  }

  int iter = 0;
  while (iter < NITER)
  {
    calculate_mean();
    reassign();

    //bsg_printf("Iteration = %d\n", iter);
    for (int i = 0; i < NCLUSTER; i++)
    {
      //bsg_printf("cluster %d = %x,%x\n", i, hex(mean_x[i]), hex(mean_y[i]));
      //bsg_print_float(mean_x[i]);
      //bsg_print_float(mean_y[i]);
    }
    iter++;
  }
  bsg_cuda_print_stat_end(0);

  // expected answer
  // cluster 0 = (3f7e843b, 3ffe8a61)
  // cluster 1 = (40005dfc, 3f6d1a70)
  // cluster 2 = (40222a3f, 401cc74e)
  if (hex(mean_x[0]) != 0x3f7e843b) bsg_fail();
  if (hex(mean_y[0]) != 0x3ffe8a61) bsg_fail();
  if (hex(mean_x[1]) != 0x40005dfc) bsg_fail();
  if (hex(mean_y[1]) != 0x3f6d1a70) bsg_fail();
  if (hex(mean_x[2]) != 0x40222a3f) bsg_fail();
  if (hex(mean_y[2]) != 0x401cc74e) bsg_fail();

  bsg_finish();
  
  bsg_wait_while(1);
}

